---
const stages = [
  {
    number: "01",
    title: "Acquire",
    description: "Automate lead capture and qualification at scale",
    solutions: ["Lead Scoring", "Attribution", "Landing Pages", "Form Automation", "API Integrations"]
  },
  {
    number: "02",
    title: "Convert",
    description: "Optimize checkout flows and conversion paths",
    solutions: ["Checkout Optimization", "Payment Systems", "Cart Recovery", "Dynamic Pricing", "A/B Testing"]
  },
  {
    number: "03",
    title: "Fulfill",
    description: "Streamline operations and order management",
    solutions: ["Order Management", "Inventory Sync", "Time Tracking", "Shipping Automation", "Workflows"]
  },
  {
    number: "04",
    title: "Retain",
    description: "Build loyalty and maximize lifetime value",
    solutions: ["WhatsApp Automation", "Klaviyo Flows", "Loyalty Programs", "Review Systems", "Churn Prediction"]
  }
];
---

<section id="services" class="services">
  <div class="services-container">
    <!-- Header -->
    <header class="services-header">
      <div class="header-label">
        <span class="label-number">02</span>
        <span class="label-text">Services</span>
      </div>
      <h2 class="services-title">
        Automation for every
        <span class="title-accent">stage of growth</span>
      </h2>
      <p class="services-subtitle">
        Custom systems that multiply your team's output at every customer touchpoint
      </p>
    </header>

    <!-- Stages Navigation -->
    <nav class="stages-nav">
      {stages.map((stage, index) => (
        <button
          class={`stage-nav-btn ${index === 0 ? 'active' : ''}`}
          data-stage={index}
        >
          <span class="nav-number">{stage.number}</span>
          <span class="nav-title">{stage.title}</span>
          <span class="nav-indicator"></span>
        </button>
      ))}
    </nav>

    <!-- Funnel Visualization -->
    <div class="funnel-wrapper">
      {stages.map((stage, index) => (
        <div
          class={`funnel-ring ${index === 0 ? 'active' : ''}`}
          data-ring={index}
          style={`--ring-index: ${index}`}
        >
          <div class="ring-number">{stage.number}</div>
          <div class="ring-content">
            <div class="ring-solutions">
              {stage.solutions.map((solution, solIndex) => (
                <span class="solution-tag" style={`--sol-index: ${solIndex}`}>
                  {solution}
                </span>
              ))}
            </div>
          </div>
        </div>
      ))}
    </div>

    <!-- Active Stage Description -->
    <div class="stage-info">
      {stages.map((stage, index) => (
        <div class={`info-panel ${index === 0 ? 'active' : ''}`} data-panel={index}>
          <h3 class="info-title">{stage.title}</h3>
          <p class="info-description">{stage.description}</p>
        </div>
      ))}
    </div>
  </div>
</section>

<script>
  import gsap from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  document.addEventListener('DOMContentLoaded', () => {
    const navBtns = document.querySelectorAll('.stage-nav-btn');
    const rings = document.querySelectorAll('.funnel-ring');
    const panels = document.querySelectorAll('.info-panel');
    const servicesSection = document.querySelector('.services');

    let currentStage = 0;

    function setActiveStage(index) {
      if (index === currentStage) return;
      currentStage = index;

      // Update nav buttons
      navBtns.forEach((btn, i) => {
        btn.classList.toggle('active', i === index);
      });

      // Update rings
      rings.forEach((ring, i) => {
        ring.classList.toggle('active', i === index);
      });

      // Update info panels
      panels.forEach((panel, i) => {
        panel.classList.toggle('active', i === index);
      });
    }

    // Click handlers
    navBtns.forEach((btn, index) => {
      btn.addEventListener('click', () => setActiveStage(index));
    });

    // Click on rings
    rings.forEach((ring, index) => {
      ring.addEventListener('click', () => setActiveStage(index));
    });

    // GSAP ScrollTrigger for pinning and stage switching
    ScrollTrigger.create({
      trigger: servicesSection,
      start: 'top top',
      end: '+=200%', // Pin for 200% of viewport height (scroll through 4 stages)
      pin: true,
      pinSpacing: true,
      onUpdate: (self) => {
        // Map scroll progress to stages (0-3)
        let stageIndex = Math.floor(self.progress * 4);
        stageIndex = Math.max(0, Math.min(3, stageIndex));
        setActiveStage(stageIndex);
      }
    });
  });
</script>

<style>
  .services {
    background: #0c0c0c;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: relative;
    overflow: hidden;
    padding: 2rem 0;
  }

  .services-container {
    max-width: 1800px;
    margin: 0 auto;
    padding: 0 clamp(1.5rem, 5vw, 4rem);
  }

  /* Header */
  .services-header {
    text-align: center;
    margin-bottom: clamp(1.5rem, 3vw, 2.5rem);
  }

  .header-label {
    display: inline-flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .label-number {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: #a7a9ac;
    letter-spacing: 0.05em;
  }

  .label-text {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: #ffffff;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }

  .services-title {
    font-family: var(--font-display);
    font-size: clamp(2rem, 5vw, 4rem);
    font-weight: 700;
    color: #ffffff;
    margin-bottom: 1rem;
    line-height: 1.05;
    letter-spacing: -0.03em;
  }

  .title-accent {
    color: var(--color-accent);
  }

  .services-subtitle {
    font-family: var(--font-body);
    font-size: clamp(1rem, 1.25vw, 1.25rem);
    color: #a7a9ac;
    max-width: 500px;
    margin: 0 auto;
  }

  /* Stages Navigation */
  .stages-nav {
    display: flex;
    justify-content: center;
    gap: clamp(1rem, 3vw, 3rem);
    margin-bottom: clamp(1.5rem, 3vw, 2.5rem);
  }

  .stage-nav-btn {
    background: none;
    border: none;
    cursor: pointer;
    text-align: center;
    padding: 1rem 0;
    position: relative;
    transition: all 0.4s var(--ease-out-quart);
  }

  .nav-number {
    display: block;
    font-family: var(--font-display);
    font-size: clamp(1.5rem, 2vw, 2rem);
    font-weight: 700;
    color: rgba(255, 255, 255, 0.2);
    margin-bottom: 0.5rem;
    transition: color 0.4s var(--ease-out-quart);
  }

  .stage-nav-btn.active .nav-number,
  .stage-nav-btn:hover .nav-number {
    color: var(--color-accent);
  }

  .nav-title {
    display: block;
    font-family: var(--font-body);
    font-size: 0.875rem;
    font-weight: 500;
    letter-spacing: 0.02em;
    color: rgba(255, 255, 255, 0.5);
    transition: color 0.4s var(--ease-out-quart);
  }

  .stage-nav-btn.active .nav-title,
  .stage-nav-btn:hover .nav-title {
    color: #ffffff;
  }

  .nav-indicator {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 2px;
    background: var(--color-accent);
    transition: width 0.4s var(--ease-out-expo);
  }

  .stage-nav-btn.active .nav-indicator {
    width: 40px;
  }

  /* Funnel Visualization */
  .funnel-wrapper {
    position: relative;
    height: 280px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-bottom: 2rem;
  }

  .funnel-ring {
    position: absolute;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid rgba(255, 255, 255, 0.08);
    border-radius: 100px;
    transition: all 0.6s var(--ease-out-expo);
    cursor: pointer;
  }

  .funnel-ring:hover {
    border-color: rgba(255, 255, 255, 0.2);
  }

  /* Progressive sizing - compact pill shapes */
  .funnel-ring[data-ring="0"] {
    width: min(95%, 900px);
    height: 60px;
    top: 0;
  }

  .funnel-ring[data-ring="1"] {
    width: min(82%, 740px);
    height: 60px;
    top: 70px;
  }

  .funnel-ring[data-ring="2"] {
    width: min(69%, 580px);
    height: 60px;
    top: 140px;
  }

  .funnel-ring[data-ring="3"] {
    width: min(56%, 420px);
    height: 60px;
    top: 210px;
  }

  .funnel-ring.active {
    border-color: var(--color-accent);
    background: rgba(0, 255, 156, 0.03);
  }

  .ring-number {
    position: absolute;
    left: clamp(20px, 4vw, 40px);
    font-family: var(--font-display);
    font-size: clamp(1.25rem, 2vw, 1.75rem);
    font-weight: 700;
    color: rgba(255, 255, 255, 0.15);
    transition: color 0.4s var(--ease-out-quart);
  }

  .funnel-ring.active .ring-number {
    color: var(--color-accent);
  }

  .ring-content {
    opacity: 0;
    transform: scale(0.95);
    transition: all 0.5s var(--ease-out-expo);
  }

  .funnel-ring.active .ring-content {
    opacity: 1;
    transform: scale(1);
  }

  .ring-solutions {
    display: flex;
    flex-wrap: nowrap;
    gap: 0.5rem;
    justify-content: center;
    align-items: center;
  }

  .solution-tag {
    padding: 0.375rem 0.875rem;
    background: var(--color-accent);
    color: #0c0c0c;
    font-family: var(--font-body);
    font-size: 0.75rem;
    font-weight: 600;
    border-radius: 100px;
    white-space: nowrap;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.4s var(--ease-out-expo);
    transition-delay: calc(var(--sol-index) * 0.05s);
  }

  .funnel-ring.active .solution-tag {
    opacity: 1;
    transform: translateY(0);
  }

  .solution-tag:hover {
    background: var(--color-accent-hover);
    transform: translateY(-2px);
  }

  /* Stage Info */
  .stage-info {
    text-align: center;
    min-height: 80px;
  }

  .info-panel {
    display: none;
  }

  .info-panel.active {
    display: block;
    animation: fadeUp 0.5s var(--ease-out-expo);
  }

  .info-title {
    font-family: var(--font-display);
    font-size: clamp(1.5rem, 2.5vw, 2rem);
    font-weight: 700;
    color: #ffffff;
    margin-bottom: 0.75rem;
  }

  .info-description {
    font-family: var(--font-body);
    font-size: 1rem;
    color: #a7a9ac;
    max-width: 400px;
    margin: 0 auto;
  }

  @keyframes fadeUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .stages-nav {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0;
    }

    .stage-nav-btn {
      padding: 0.75rem 0.5rem;
    }

    .nav-title {
      font-size: 0.75rem;
    }

    .funnel-wrapper {
      height: 240px;
    }

    .funnel-ring[data-ring="0"] { height: 50px; top: 0; }
    .funnel-ring[data-ring="1"] { height: 50px; top: 60px; }
    .funnel-ring[data-ring="2"] { height: 50px; top: 120px; }
    .funnel-ring[data-ring="3"] { height: 50px; top: 180px; }

    .ring-solutions {
      flex-wrap: wrap;
      gap: 0.375rem;
      padding: 0 2rem;
    }

    .solution-tag {
      padding: 0.375rem 0.75rem;
      font-size: 0.6875rem;
    }

    .ring-number {
      left: 15px;
    }
  }
</style>
